<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link id="favicon" rel="icon" type="image/svg+xml" />
    <title>Broadcast Channel Worker</title>
  </head>
  <body>
    <h1>Broadcast Channel Worker</h1>
    <pre>
      <script type="module" style="display: block">
        import BroadcastChannelWorker from "https://johnhenry.github.io/std/js/broadcast-channel-worker@0.0.0/index.mjs";
        import textToDOMNodes from "https://johnhenry.github.io/std/js/text-to-DOM-nodes@0.0.0/index.mjs";
        import { PNG , SVG } from "https://johnhenry.github.io/std/js/liedenticons@0.0.0/index.mjs";
        const transform = (message, from, to) =>
`${new Date()}

Dear ${to || "ALL"},

${message}

-- ${from}
`;
        const onmessage = (message, from, to)=>{
        const letter = transform(message, from, to);
        console.log(transform(message, from, to));
        globalThis.document.body.append(...textToDOMNodes(
`
<hr />
<img src=${new SVG(String(from)).toString(true, true)} style="display:inline">
<pre>
${letter}
</pre>
`))
        };
        const worker = new BroadcastChannelWorker({onmessage});
        console.log(worker.id, new Date());

        const favicon = globalThis.document.getElementById('favicon');
        favicon.href = new PNG(String(worker.id)).toString();

        worker.postMessage('Hello World!');
        setTimeout(()=>{
          const peers = [...worker.peers]
          const peer = peers[Math.floor(Math.random() * peers.length)];
          if(peer){
            worker.postMessage('Hello You!', peer);
          }
        }, 1000);

        worker.addEventListener('ping', ({detail})=>{
          console.log("received ping from:", detail);
        });
        worker.addEventListener('ack', ({detail})=>{
          console.log("received ack from:", detail);
        });
        setInterval(()=>{
          [...worker.peers].forEach(peer=>{
            console.log("sending ping to:", peer);
            worker.ping(peer);
          });
        }, 2000);
        window.bcw = worker;
      </script>
    </pre>
    <a href="#" target="_blank">â†ª new peer</a>
  </body>
</html>
