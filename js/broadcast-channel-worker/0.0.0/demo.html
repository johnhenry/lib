<section>
  <link rel="stylesheet" href="../../../css/on-display/0.0.0/scripts.css" />
  <h1>Broadcast Channel Worker</h1>
  <pre>
      <script type="module">
        import BroadcastChannelWorker from "../../../js/broadcast-channel-worker/0.0.0/index.mjs";
        import textToDOMNodes from "../../../js/text-to-DOM-nodes/0.0.0/index.mjs";
        import { PNG , SVG } from "../../../js/liedenticon/0.0.0/index.mjs";
        const transform = (message, from, to) =>
`${new Date()}

Dear ${to || "ALL"},

${message}

-- ${from}
`;
        const onmessage = (message, from, to)=>{
        const letter = transform(message, from, to);
        console.log(transform(message, from, to));
        globalThis.document.body.append(...textToDOMNodes(
`
<hr />
<img src=${new SVG(String(from)).toString(true, true)} style="display:inline">
<pre>
${letter}
</pre>
`))
        };
        const worker = new BroadcastChannelWorker({onmessage});
        console.log(`${worker.id} has entered`, new Date());

        try{
          const favicon = globalThis.document.querySelector('[rel=icon]');
          favicon.href = new PNG(String(worker.id)).toString();
        }catch{
        }


        window.onbeforeunload = function(e) {
            worker.postMessage('Have a good day!');
            console.log(`${worker.id} has left`, new Date());
        };

        worker.postMessage('Hello World!');
        setTimeout(()=>{
          const peers = [...worker.peers]
          const peer = peers[Math.floor(Math.random() * peers.length)];
          if(peer){
            worker.postMessage('Hey You!', peer);
          }
        }, 1000);

        worker.addEventListener('ping', ({detail})=>{
          console.log("received ping from:", detail);
        });
        worker.addEventListener('ack', ({detail})=>{
          console.log("received ack from:", detail);
        });
        setInterval(()=>{
          [...worker.peers].forEach(peer=>{
            console.log("sending ping to:", peer);
            worker.ping(peer);
          });
        }, 2000);
        window.bcw = worker;
      </script>
    </pre>
  <a href="#" target="_blank">â†ª new peer</a>
</section>
